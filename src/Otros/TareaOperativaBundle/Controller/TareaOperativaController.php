<?phpnamespace Otros\TareaOperativaBundle\Controller;use Symfony\Bundle\FrameworkBundle\Controller\Controller;use Sensio\Bundle\FrameworkExtraBundle\Configuration\Route;use Symfony\Component\HttpFoundation\Response;use Symfony\Component\HttpFoundation\Request;use Otros\TareaOperativaBundle\Entity\TareaOperativa;/** * @Route("to/") */class TareaOperativaController extends Controller{    /**     * @Route("list")     */    public function listAction(Request $rq)    {        $array = array();        $rq->get("Responsable") === "true" ? $dep_id = $this->get('session')->get('departamento_id') : $dep_id = "";        if ($rq->get('Prioridad')) {            $data = $this->getDoctrine()->getManager()->getRepository('TareaOperativaBundle:TareaOperativa')->findTareasOperativas(                "Pendiente",                $dep_id,                $this->get('session')->get('unidad_organizativa_id'),                true            );        } else {            $data = $this->getDoctrine()->getManager()->getRepository('TareaOperativaBundle:TareaOperativa')->findTareasOperativas(                "Pendiente",                $dep_id,                $this->get('session')->get('unidad_organizativa_id')            );        }        foreach ($data as $entity)        {            $var = $entity->toArray($dep_id); // Paso $dep_id para activar la opcion de editar Accion...            if (is_array($var))            {                $array[] = $var;            }        }        return new Response('({"total":"'.count($array).'","data":'.json_encode($array).'})');    }        /**     * @Route("add")     */        public function addAction(Request $rq)    {        $em = $this->getDoctrine()->getManager();        $tarea = new TareaOperativa();        $tarea->setFechaCreacion(new \DateTime($rq->get("FechaInicial")));        $tarea->setDescripcion($rq->get("Descripcion"));        $tarea->setNumero($em->getRepository('TareaOperativaBundle:TareaOperativa')->findMaxNumero($this->get('session')->get('unidad_organizativa_id')));        $tarea->setPrioridad(false);        if (count($this->get('validator')->validate($tarea)) > 0)        {            return new Response('Unico');        }        $em->persist($tarea);        $em->flush();        //-!        $to = $this->get('to.util');        $to->addTrabajadores($tarea, $rq->get("Responsables"));        $to->addEstado($tarea, $rq->get("FechaFinal"));        $to->addPeriodo($tarea, $rq->get("PeriodoChequeo"));        return new Response('');    }        /**     * @Route("edit")     */     public function editAction(Request $rq)    {        $em = $this->getDoctrine()->getManager();        $tarea = $em->getRepository('TareaOperativaBundle:TareaOperativa')->find($rq->get("Id"));        $tarea->setFechaCreacion(new \DateTime($rq->get("FechaInicial")));        $tarea->setDescripcion($rq->get("Descripcion"));        if (count($this->get('validator')->validate($tarea)) > 0)        {            return new Response('Unico');        }        $em->persist($tarea);        $em->flush();        //-!        $to = $this->get('to.util');        $to->addTrabajadores($tarea, $rq->get("Responsables"), "edit");        $to->addEstado($tarea, $rq->get("FechaFinal"), "edit");        $to->addPeriodo($tarea, $rq->get("PeriodoChequeo"), "edit");        return new Response('');    }        /**     * @Route("remove")     */      public function removeAction(Request $rq)    {        return new Response($this->get('otros.util')->remove($rq->get("ids"), 'TareaOperativaBundle:TareaOperativa'));    }    /**     * @Route("prioridad")     * @param Request $rq     * @return Response     */    public function prioridadAction(Request $rq)    {        $entity = $this->getDoctrine()->getManager()->getRepository('TareaOperativaBundle:TareaOperativa')->find($rq->get("id"));        $entity->setPrioridad($rq->get("prioridad"));        return new Response($this->get('otros.util')->validate($entity));    }}